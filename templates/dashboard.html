{% extends "layout.html" %}

{% block title %}
    Dashboard de Picking
{% endblock %}

{% block styles %}
    <style>
        .estado { font-weight: bold; padding: 0.2em 0.5em; border-radius: 4px; color: white; display: inline-block; text-transform: capitalize; }
        .estado-PENDIENTE { background-color: #f0ad4e; }
        .estado-EN_PICKING { background-color: #337ab7; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #ddd; padding: 0.8em; text-align: left; vertical-align: middle; }
        th { background-color: #f8f9fa; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        .action-link { 
            color: #007bff;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            text-align: center;
        }
        .action-link:hover { text-decoration: underline; }
        .action-link-picking {
            background-color: #5cb85c;
            color: white;
            font-weight: bold;
        }
        .action-link-picking:hover {
            background-color: #4cae4c;
            text-decoration: none;
        }
        .action-button-take {
            background-color: #f0ad4e;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: sans-serif;
            font-size: 14px;
        }
        .action-button-take:hover {
            background-color: #ec971f;
        }

        .submit-btn {
            margin-top: 1.5em;
            padding: 12px 25px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .submit-btn:hover { background-color: #218838; }

        .navegacion-modulos, .filtros-container {
            margin-bottom: 1.5em;
            padding: 1em;
            background-color: #e9ecef;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }

        .filtros-container a {
            text-decoration: none;
            color: #007bff;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin-right: 0.5rem;
            border: 1px solid transparent;
            font-weight: 500;
        }
        .filtros-container a.activo {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-color: #007bff;
        }

        .asignacion-container {
            margin-top: 1.5em;
            padding: 1em;
            background: #f0f0f0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .asignacion-container label {
            font-weight: bold;
            margin-right: 10px;
        }
        .asignacion-container select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .estado-CANCELADA { background-color: #777; }
        tr.orden-cancelada {
            background-color: #f2f2f2 !important;
            text-decoration: line-through;
            opacity: 0.6;
        }


         /* Estilos Responsive para la Tabla */
    @media screen and (max-width: 768px) {
        table { border: 0; }
        table thead {
            border: none;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }
        table tr {
            border-bottom: 3px solid #ddd;
            display: block;
            margin-bottom: .625em;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table td {
            border-bottom: 1px solid #ddd;
            display: block;
            font-size: .8em;
            text-align: right; /* Alinear el contenido a la derecha */
        }
        table td::before {
            /* Usamos el atributo data-label para mostrar el nombre de la columna */
            content: attr(data-label);
            float: left; /* Alinear la etiqueta a la izquierda */
            font-weight: bold;
            text-transform: uppercase;
        }
        table td:last-child { border-bottom: 0; }
    }
    </style>
{% endblock %}

{% block content %}
    <h1>Dashboard de Picking</h1>

    <!-- NAVEGACIÓN ENTRE MÓDULOS -->
    <div class="navegacion-modulos">
        <strong>Módulos:</strong>
        <a href="{{ url_for('dashboard') }}" style="font-weight: bold; color: #337ab7;">Picking</a> |
        <a href="{{ url_for('dashboard_packing') }}">Packing</a> |
        <a href="{{ url_for('dashboard_despacho') }}">Despacho</a>
        {% if current_user.role == 'admin' %}
        | <a href="{{ url_for('reportes_y_busqueda') }}">Reportes</a>
        {% endif %}
    </div>

    <!-- === NUEVO: PANEL DE ACCIONES REQUERIDAS PARA OPERARIO === -->
{% if current_user.role == 'operario' and ordenes_a_devolver %}
<div class="alert alert-warning" style="background-color: #fcf8e3; border: 1px solid #faebcc; color: #8a6d3b; padding: 1rem; margin-bottom: 1.5rem; border-radius: 5px;">
    <h4>¡Atención! Acciones Requeridas</h4>
    <p>Las siguientes órdenes fueron canceladas después de que recogiste los artículos. Por favor, devuelve los productos a su inventario y confirma la acción.</p>
    <ul style="margin-top: 1rem;">
        {% for orden in ordenes_a_devolver %}
        <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span>Orden cancelada: <strong>#{{ orden.numero_pedido }}</strong></span>
            <form action="{{ url_for('confirmar_devolucion', orden_id=orden.id) }}" method="POST" style="margin: 0;">
                <button type="submit" class="action-link" style="background-color:#5cb85c; color:white; border:none; cursor:pointer;">Confirmar Devolución</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}
<!-- === FIN DEL PANEL === -->

    <!-- MENÚ DE FILTROS POR ESTADO -->
    <div class="filtros-container">
        <strong>Ver estado:</strong>
        <a href="{{ url_for('dashboard', estado='PENDIENTE') }}" class="{{ 'activo' if (filtro_actual == 'PENDIENTE' or not filtro_actual and current_user.role != 'admin') else '' }}">
           PENDIENTE <span id="pendientes-badge" style="display: none;">0</span>
        </a>
        {% for estado in estados if estado != 'PENDIENTE' %}
            <a href="{{ url_for('dashboard', estado=estado) }}" class="{{ 'activo' if filtro_actual == estado else '' }}">{{ estado.replace('_', ' ') }}</a>
        {% endfor %}
        <a href="{{ url_for('dashboard') }}" class="{{ 'activo' if not filtro_actual and current_user.role == 'admin' else '' }}">Vista por Defecto</a>
    </div>

        <!-- === NUEVO: PANEL DE ALERTA DE NUEVAS ÓRDENES (OCULTO) === -->
    <div id="new-orders-alert" class="flash flash-info" style="display: none; cursor: pointer; text-align: center;">
        <strong>¡Hay nuevas órdenes pendientes!</strong> Haz clic aquí para actualizar la lista.
    </div>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('crear_lote') }}" method="POST">
        <table>
            <thead>
                <tr>
                    <th>Sel.</th>
                    <th>Pedido #</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th style="text-align: center;">Asignado a</th>
                    <th style="text-align: center;">Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for orden in ordenes %}

                    <tr>
                        <td data-label="Seleccionar">{% if orden.estado == 'PENDIENTE' %}<input type="checkbox" ...>{% endif %}</td>
                        <td data-label="Pedido #">{{ orden.numero_pedido }}</td>
                        <td data-label="Cliente">{{ orden.cliente_nombre }}</td>
                        <td data-label="Estado"><span class="estado...">{{ orden.estado... }}</span></td>
                        <td data-label="Asignado a">...</td>
                        <td data-label="Acción">...</td>
                    </tr>
                    <tr class="{{ 'orden-cancelada' if orden.estado == 'CANCELADA' else '' }}">
                        <td style="text-align: center;">
                            {% if orden.estado == 'PENDIENTE' %}
                                <input type="checkbox" name="orden_id" value="{{ orden.id }}">
                            {% endif %}
                        </td>
                        <td>{{ orden.numero_pedido }}</td>
                        <td>{{ orden.cliente_nombre }}</td>
                        <td>
                            <span class="estado estado-{{ orden.estado }}">{{ orden.estado.replace('_', ' ') }}</span>
                        </td>
                        <td style="text-align: center;">
                            {% if orden.lote and orden.lote.operario %}
                                <strong>{{ orden.lote.operario.username }}</strong>
                            
                            {% elif orden.estado == 'EN_PICKING' %}
                                <!-- Si está en picking y sin asignar, mostramos el botón "Tomar" para operarios -->
                                {% if current_user.role == 'operario' %}
                                    <form action="{{ url_for('tomar_lote', lote_id=orden.lote_id) }}" method="POST" style="margin: 0;">
                                        <button type="submit" class="action-button-take">
                                            Tomar Lote
                                        </button>
                                    </form>
                                {% else %}
                                    <!-- Si es admin, solo ve el texto -->
                                    <span style="color: #777; font-style: italic;">Sin Asignar</span>
                                {% endif %}
                        
                            {% else %}
                                <span style="color: #ccc;">--</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if orden.estado == 'EN_PICKING' and orden.lote and (current_user.role == 'admin' or (orden.lote.operario and current_user.id == orden.lote.operario_id)) %}
                                <a href="{{ url_for('detalle_lote', lote_id=orden.lote_id) }}" class="action-link action-link-picking">Continuar Picking</a>
                            {% else %}
                                <a href="{{ url_for('detalle_orden', orden_id=orden.id) }}" class="action-link">Ver Detalle</a>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2em;">
                            No hay órdenes que coincidan con el filtro actual ('{{ (filtro_actual or "Por Defecto").replace('_', ' ') }}').
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- El botón solo debe aparecer si hay órdenes PENDIENTES para seleccionar -->
        {% if ordenes | selectattr('estado', 'equalto', 'PENDIENTE') | list %}
            
            <!-- Mostramos este bloque SOLO si el usuario es admin y hay operarios -->
            {% if current_user.role == 'admin' and operarios %}
            <div class="asignacion-container">
                <label for="operario_id">Asignar Lote a (Opcional):</label>
                <select name="operario_id" id="operario_id">
                    <option value="">-- Dejar sin asignar --</option>
                    {% for operario in operarios %}
                    <option value="{{ operario.id }}">{{ operario.username }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <button type="submit" class="submit-btn">Crear Lote de Picking con Órdenes Seleccionadas</button>
        
        {% endif %}
    </form>
{% endblock %}

<!-- En templates/dashboard.html -->

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const badge = document.getElementById('pendientes-badge');
    const alertPanel = document.getElementById('new-orders-alert');
    const audioNotification = new Audio("{{ url_for('static', filename='sounds/notification.mp3') }}");
    
    // Asumimos que el audio ya fue desbloqueado por la interacción del usuario en layout.html
    // si el usuario es un admin. Para operarios, también funcionará tras el primer clic.
    let audioUnlocked = false; 
    function unlockAudio() {
        if(audioUnlocked) return;
        new Audio("{{ url_for('static', filename='sounds/silent.mp3') }}").play().then(() => {
            audioUnlocked = true;
        }).catch(()=>{});
    }
    document.body.addEventListener('click', unlockAudio, { once: true });


    let currentPendingCount = -1; // Iniciamos en -1 para forzar la primera actualización

    function checkNewOrders() {
        fetch("{{ url_for('api_ordenes_pendientes_count') }}")
            .then(response => response.json())
            .then(data => {
                if (data && data.pendientes !== undefined) {
                    const newCount = data.pendientes;

                    // La primera vez, solo actualizamos el contador sin notificar
                    if (currentPendingCount === -1) {
                        currentPendingCount = newCount;
                    } 
                    // Si el nuevo conteo es mayor, notificamos
                    else if (newCount > currentPendingCount) {
                        audioNotification.volume = 0.5;
                        audioNotification.play().catch(e => console.error("Audio de nueva orden bloqueado:", e));
                        alertPanel.style.display = 'block'; // Mostramos el panel de alerta
                    }
                    
                    // Siempre actualizamos el conteo guardado y el badge
                    currentPendingCount = newCount;
                    updatePendingBadge(currentPendingCount);
                }
            })
            .catch(error => console.error('Error chequeando nuevas órdenes:', error));
    }

    function updatePendingBadge(count) {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    // Al hacer clic en el panel de alerta, recargamos la página para ver las nuevas órdenes
    alertPanel.addEventListener('click', function() {
        window.location.href = "{{ url_for('dashboard', estado='PENDIENTE') }}";
    });

    // Iniciar el chequeo
    checkNewOrders(); // Chequeo inmediato
    setInterval(checkNewOrders, 30000); // Y luego cada 30 segundos
});
</script>
{% endblock %}



