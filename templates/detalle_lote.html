{% extends "layout.html" %}

{% block title %}Picking Lote #{{ lote.id }}{% endblock %}

{% block styles %}
<style>
    /* Estilos generales del contenedor */
    .container { max-width: 900px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 0.5em; }
    .back-link { display: inline-block; margin-bottom: 1rem; color: #337ab7; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    
    /* Estilos del formulario de escaneo */
    .scan-form { margin: 2em 0; display: flex; gap: 10px; flex-direction: column; }
    .scan-input { flex-grow: 1; padding: 12px; font-size: 18px; border: 2px solid #ccc; border-radius: 5px; transition: border-color 0.3s; }
    .scan-input:focus { border-color: #337ab7; outline: none; }
    .scan-btn { padding: 12px 25px; font-size: 16px; background-color: #337ab7; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
    .scan-btn:hover { background-color: #286090; }

    /* Estilos para el feedback visual dinámico */
    .scan-feedback {
        padding: 1em; margin-top: 1em; border-radius: 5px; font-weight: bold;
        display: none; text-align: center;
    }
    .scan-feedback.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .scan-feedback.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    /* Estilos de la tabla de artículos */
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ddd; padding: 0.8em; text-align: left; vertical-align: middle; }
    th { background-color: #f8f9fa; }
    td strong { font-size: 1.1em; }
    
    /* --- ESTILOS PARA LAS NUEVAS FUNCIONALIDADES --- */
    .view-options { margin-bottom: 1rem; padding: 0.5rem; background-color: #f9f9f9; border-radius: 5px; }
    .view-options label { font-weight: bold; cursor: pointer; }

    .action-buttons button { margin: 2px; }
    .incidencia-btn { background-color: #f0ad4e; color: white; border: none; padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    .incidencia-btn:hover { background-color: #ec971f; }
    .completar-btn { background-color: #337ab7; color: white; border: none; padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    .completar-btn:hover { background-color: #286090; }
    
    tr.incidencia-reportada { background-color: #fcf8e3 !important; text-decoration: line-through; color: #8a6d3b; opacity: 0.7; }
    .item-completado { background-color: #dff0d8 !important; color: #3c763d; }
    body.ocultar-completados .item-completado { display: none; }

    /* Estilos del Modal (sin cambios) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: white; padding: 2em; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
    .modal-close-btn { font-size: 1.5rem; font-weight: bold; border: none; background: none; cursor: pointer; }
    .modal-body .form-group { margin-bottom: 1rem; }
    .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
    .modal-body input, .modal-body select, .modal-body textarea { width: 100%; padding: 0.7rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    .modal-actions { margin-top: 1.5em; text-align: right; }
    .modal-submit { background-color: #d9534f; color: white; padding: 0.7em 1.5em; border-radius: 5px; border: none; cursor: pointer; }

    /* Estilos de la barra de progreso */
    .progress-bar { background-color: #e9ecef; border-radius: 5px; overflow: hidden; height: 22px; border: 1px solid #ddd; }
    .progress { background-color: #5cb85c; color: white; text-align: center; font-weight: bold; height: 100%; line-height: 22px; transition: width 0.4s ease-in-out; }
    
    /* Estilos del botón de finalizar */
    .finalizar-btn { background-color: #28a745; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; }
    .finalizar-btn:disabled { background-color: #ccc; cursor: not-allowed; }

    @media (min-width: 768px) {
        .scan-form { flex-direction: row; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('dashboard') }}" class="back-link">← Volver al Dashboard</a>
    <h1>Picking para Lote #{{ lote.id }}</h1>

    <form id="scan-form" class="scan-form">
        <input type="text" id="scan-input" class="scan-input" placeholder="Escanear o escribir código de artículo..." autofocus onfocus="this.select()">
        <button type="submit" class="scan-btn">Escanear</button>
    </form>
    <div id="scan-feedback" class="scan-feedback"></div>

    <div class="view-options">
        <label>
            <input type="checkbox" id="toggle-ocultar-completados">
            Ocultar ítems completados
        </label>
    </div>
    
    <h2>Lista de Recogida Consolidada</h2>
    <table>
        <thead>
            <tr>
                <th>Código Artículo</th>
                <th>Descripción</th>
                <th>Progreso</th>
                <th style="text-align: center;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for codigo, item in lista_consolidada %}
            <tr id="item-row-{{ codigo }}" class="item-row" data-codigo="{{ codigo }}">
                <td><strong>{{ codigo }}</strong></td>
                <td>{{ item.descripcion }}</td>
                <td>
                    <span id="progreso-texto-{{ codigo }}">{{ item.recogido }} / {{ item.solicitado }}</span>
                    <div class="progress-bar">
                        {% set progreso_inicial = (item.recogido / item.solicitado) * 100 if item.solicitado > 0 else 0 %}
                        <div id="progreso-barra-{{ codigo }}" class="progress" style="width: {{ progreso_inicial }}%;">
                            {{ '%.0f'|format(progreso_inicial) }}%
                        </div>
                    </div>
                </td>
                <td style="text-align: center;" class="action-buttons">
                    <button class="incidencia-btn" data-codigo="{{ codigo }}" data-descripcion="{{ item.descripcion }}" data-solicitado="{{ item.solicitado }}">
                        Incidencia
                    </button>
                    {% if current_user.role == 'admin' %}
                    <button class="completar-btn" data-codigo="{{ codigo }}">Completar</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="text-align: center; margin-top: 2.5em;">
        <form action="{{ url_for('finalizar_lote', lote_id=lote.id) }}" method="POST">
            <button id="finalizar-btn" type="submit" class="finalizar-btn" {% if not picking_completo %}disabled{% endif %}>
                Enviar Lote a Packing
            </button>
        </form>
    </div>
</div>

<div id="modal-incidencia" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Reportar Incidencia</h3>
            <button id="modal-close" class="modal-close-btn">×</button>
        </div>
        <div class="modal-body">
            <p>Artículo: <strong id="modal-item-info"></strong></p>
            <form id="form-incidencia">
                <input type="hidden" id="modal-codigo-articulo" name="codigo_articulo">
                <div class="form-group">
                    <label for="modal-tipo-incidencia">Tipo de Incidencia</label>
                    <select id="modal-tipo-incidencia" name="tipo_incidencia" required>
                        <option value="">-- Seleccione un tipo --</option>
                        <option value="STOCK_CERO">No hay stock</option>
                        <option value="DAÑADO">Artículo dañado</option>
                        <option value="UBICACION_ERRONEA">Ubicación incorrecta</option>
                        <option value="OTRO">Otro (especificar en notas)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal-cantidad-recogida">Cantidad que SÍ pudo recoger</label>
                    <input type="number" id="modal-cantidad-recogida" name="cantidad_recogida" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="modal-nota">Notas (opcional)</label>
                    <textarea id="modal-nota" name="nota" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="modal-submit">Confirmar Incidencia</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- SECCIÓN DE ELEMENTOS GLOBALES ---
    const audioSuccess = new Audio("{{ url_for('static', filename='sounds/success.mp3') }}");
    const audioError = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");
    const finalizarBtn = document.getElementById('finalizar-btn');
    const toggleOcultar = document.getElementById('toggle-ocultar-completados');
    const scanForm = document.getElementById('scan-form');
    const scanInput = document.getElementById('scan-input');
    const scanBtn = document.querySelector('.scan-btn'); // Obtenemos el botón
    const feedbackDiv = document.getElementById('scan-feedback');
    const modal = document.getElementById('modal-incidencia');
    const closeModalBtn = document.getElementById('modal-close');
    const incidenciaForm = document.getElementById('form-incidencia');
    
    // --- INICIO: Implementación del "Guardia" de Envío ---
    let isSubmitting = false; 
    // --- FIN: Implementación del "Guardia" ---

    // --- LÓGICA DE ESCANEO ---
    scanForm.addEventListener('submit', function(event) {
        event.preventDefault(); 
        
        // --- INICIO: Lógica del Guardia ---
        // Si ya se está procesando un escaneo, no hacemos nada.
        if (isSubmitting) {
            return; 
        }
        // Bloqueamos nuevos envíos
        isSubmitting = true;
        scanBtn.disabled = true; // Deshabilitamos el botón visualmente
        scanBtn.textContent = 'Procesando...';
        // --- FIN: Lógica del Guardia ---

        const codigo = scanInput.value.trim();
        if (!codigo) {
            // Si el campo está vacío, liberamos el guardia
            isSubmitting = false;
            scanBtn.disabled = false;
            scanBtn.textContent = 'Escanear';
            return;
        }
        
        fetch("{{ url_for('api_escanear_item_lote', lote_id=lote.id) }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo_articulo: codigo }),
        }).then(res => res.json()).then(data => {
            if (data.success) { audioSuccess.play(); updateUI(data); showFeedback(data.message, 'success');
            } else { audioError.play(); showFeedback(data.message, 'error'); }
        }).catch(err => { console.error(err); showFeedback('Error de conexión.', 'error');
        }).finally(() => { 
            scanInput.value = ''; 
            scanInput.focus();
            
            // --- INICIO: Liberación del Guardia ---
            // Cuando la petición termina (éxito o error), liberamos el formulario.
            isSubmitting = false;
            scanBtn.disabled = false;
            scanBtn.textContent = 'Escanear';
            // --- FIN: Liberación del Guardia ---
        });
    });


    // --- LÓGICA DE INCIDENCIAS ---
    document.querySelectorAll('.incidencia-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('modal-item-info').textContent = `${this.dataset.codigo} - ${this.dataset.descripcion}`;
            document.getElementById('modal-codigo-articulo').value = this.dataset.codigo;
            document.getElementById('modal-cantidad-recogida').max = this.dataset.solicitado;
            modal.style.display = 'flex';
        });
    });
    function closeModal() { modal.style.display = 'none'; incidenciaForm.reset(); }
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });
    incidenciaForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const codigo = document.getElementById('modal-codigo-articulo').value;
        const url = `/api/lote/{{ lote.id }}/item/${codigo}/reportar-incidencia`;
        const formData = {
            tipo_incidencia: document.getElementById('modal-tipo-incidencia').value,
            nota: document.getElementById('modal-nota').value,
            cantidad_recogida: parseInt(document.getElementById('modal-cantidad-recogida').value, 10)
        };
        if (!formData.tipo_incidencia) { alert('Seleccione un tipo de incidencia.'); return; }
        fetch(url, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                audioError.play(); showFeedback('Incidencia reportada.', 'success');
                const row = document.getElementById(`item-row-${codigo}`);
                row.classList.add('incidencia-reportada');
                row.querySelector('.incidencia-btn').disabled = true;
                row.querySelector('.completar-btn')?.setAttribute('disabled', true);
                checkIfLoteIsComplete();
                closeModal();
            } else { audioError.play(); alert(`Error: ${data.message}`); }
        }).catch(err => { console.error(err); alert('Error de conexión.'); });
    });
    
    // --- LÓGICA PARA BOTÓN "COMPLETAR" DEL ADMIN ---
    document.querySelectorAll('.completar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const codigo = this.dataset.codigo;
            if (!confirm(`¿Marcar el ítem ${codigo} como 100% recogido?`)) return;
            const url = `/api/lote/{{ lote.id }}/codigo/${codigo}/completar`;
            fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(res => res.json())
                .then(data => {
                    if (data.success) { audioSuccess.play(); updateUI(data); showFeedback(data.message, 'success');
                    } else { audioError.play(); showFeedback(data.message || 'Error', 'error'); }
                }).catch(err => { console.error(err); showFeedback('Error de conexión.', 'error'); });
        });
    });

    // --- LÓGICA PARA CHECKBOX "OCULTAR COMPLETADOS" ---
    toggleOcultar.addEventListener('change', function() {
        document.body.classList.toggle('ocultar-completados', this.checked);
    });

    // --- FUNCIONES AUXILIARES DE UI ---
    function updateUI(data) {
        const row = document.getElementById(`item-row-${data.codigo_articulo}`);
        if (!row) return;
        const texto = row.querySelector(`#progreso-texto-${data.codigo_articulo}`);
        const barra = row.querySelector(`#progreso-barra-${data.codigo_articulo}`);
        if (texto) texto.textContent = `${data.recogido} / ${data.solicitado}`;
        if (barra) {
            const porcentaje = data.solicitado > 0 ? (data.recogido / data.solicitado) * 100 : 100;
            barra.style.width = `${porcentaje}%`;
            barra.textContent = `${Math.round(porcentaje)}%`;
        }
        row.classList.toggle('item-completado', data.recogido >= data.solicitado);
        checkIfLoteIsComplete();
    }
    
    function showFeedback(message, type) {
        feedbackDiv.textContent = message;
        feedbackDiv.className = `scan-feedback ${type}`;
        feedbackDiv.style.display = 'block';
        setTimeout(() => { feedbackDiv.style.display = 'none'; }, 3000);
    }

    function checkIfLoteIsComplete() {
        let completo = true;
        document.querySelectorAll('.item-row').forEach(row => {
            if (!row.classList.contains('item-completado') && !row.classList.contains('incidencia-reportada')) {
                completo = false;
            }
        });
        finalizarBtn.disabled = !completo;
    }

    // --- INICIALIZACIÓN DE LA VISTA ---
    function inicializarVista() {
        document.querySelectorAll('.item-row').forEach(row => {
            const texto = row.querySelector('[id^="progreso-texto-"]').textContent;
            const [recogido, solicitado] = texto.split('/').map(n => parseInt(n.trim()));
            if (recogido >= solicitado) {
                row.classList.add('item-completado');
            }
        });
        checkIfLoteIsComplete(); // Comprobar estado al cargar la página
    }
    
    inicializarVista();
});
</script>
{% endblock %}