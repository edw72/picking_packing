{% extends "layout.html" %}

{% block title %}Packing Pedido #{{ orden.numero_pedido }}{% endblock %}

{% block styles %}
<style>
    /* --- Estilos Base --- */
    .container { 
        max-width: 900px; 
        margin: 2em auto; 
        background: white; 
        padding: 2em; 
        border-radius: 8px; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1, h2 { 
        border-bottom: 2px solid #eee; 
        padding-bottom: 0.5em; 
    }
    .back-link { 
        display: inline-block; 
        margin-bottom: 1rem; 
        color: #337ab7; 
        text-decoration: none; 
    }
    .back-link:hover { text-decoration: underline; }
    
    /* --- Formulario de Escaneo --- */
    .scan-form { 
        margin: 2em 0; 
        display: flex; 
        gap: 10px; 
        flex-direction: column; /* Apilado por defecto para móviles */
    }
    .scan-input, .scan-btn { 
        width: 100%; 
        font-size: 1.2rem; 
        padding: 15px; 
        border-radius: 5px;
    }
    .scan-input { border: 2px solid #ccc; }
    .scan-input:focus { border-color: #337ab7; outline: none; }
    .scan-btn { 
        margin-top: 0.5em; 
        background-color: #337ab7; 
        color: white; 
        border: none; 
        cursor: pointer;
    }

    /* --- Feedback y Opciones de Vista --- */
    .scan-feedback { padding: 1em; margin-top: 1em; border-radius: 5px; font-weight: bold; display: none; text-align: center; }
    .scan-feedback.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .scan-feedback.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .view-options { margin: 1rem 0; padding: 0.5rem; background-color: #f9f9f9; border-radius: 5px; }
    .view-options label { font-weight: bold; cursor: pointer; }

    /* --- Tabla y Acciones --- */
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ddd; padding: 0.8em; text-align: left; vertical-align: middle; }
    th { background-color: #f8f9fa; }
    .completar-btn { background-color: #337ab7; color: white; border: none; padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    
    /* --- Lógica Visual de Ocultar/Mostrar --- */
    .item-completado { background-color: #dff0d8 !important; color: #3c763d; }
    body.ocultar-completados .item-completado { display: none; }

    /* --- Barra de Progreso --- */
    .progress-bar { background-color: #e9ecef; border-radius: 5px; overflow: hidden; height: 22px; border: 1px solid #ddd; }
    .progress { background-color: #337ab7; color: white; text-align: center; font-weight: bold; height: 100%; line-height: 22px; transition: width 0.4s ease-in-out; }
    
    /* --- Botón Finalizar --- */
    .finalizar-btn { background-color: #28a745; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; }
    .finalizar-btn:disabled { background-color: #ccc; cursor: not-allowed; }

    /* --- Media Query para Escritorio --- */
    @media (min-width: 768px) {
        .scan-form { flex-direction: row; }
        .scan-btn { margin-top: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container"> <!-- Eliminado el .card de aquí para evitar doble fondo blanco -->
    <a href="{{ url_for('dashboard_packing') }}" class="back-link">← Volver a Packing</a>
    <h1>Verificación de Packing para Pedido #{{ orden.numero_pedido }}</h1>

    <form id="scan-form-packing" class="scan-form">
        <input type="text" id="scan-input-packing" class="scan-input" placeholder="Escanear artículo para verificar..." autofocus>
        <button type="submit" class="scan-btn">Escanear</button>
    </form>
    <div id="scan-feedback-packing" class="scan-feedback"></div>

    <div class="view-options">
        <label>
            <input type="checkbox" id="toggle-ocultar-completados">
            Ocultar ítems completados
        </label>
    </div>

    <h2>Artículos de la Orden</h2>
    <table>
        <thead>
            <tr>
                <th>Código</th>
                <th>Descripción</th>
                <th>Progreso</th>
                {% if current_user.role == 'admin' %}<th>Acción</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in orden.items %}
                <tr class="item-row" id="item-row-{{ item.codigo_articulo }}">
                    <td><strong>{{ item.codigo_articulo }}</strong></td>
                    <td>{{ item.descripcion_articulo }}</td>
                    <td>
                        {% set escaneados = packing_counts.get(item.codigo_articulo, 0) %}
                        {% set solicitados = item.cantidad_solicitada %}
                        <span id="progreso-texto-{{ item.codigo_articulo }}">{{ escaneados }} / {{ solicitados }}</span>
                        <div class="progress-bar">
                            {% set progreso_inicial = (escaneados / solicitados) * 100 if solicitados > 0 else (100 if solicitados == 0 else 0) %}
                            <div id="progreso-barra-{{ item.codigo_articulo }}" class="progress" style="width: {{ progreso_inicial }}%;">
                                {{ '%.0f'|format(progreso_inicial) }}%
                            </div>
                        </div>
                    </td>
                    {% if current_user.role == 'admin' %}
                    <td style="text-align: center;" class="action-buttons">
                        <button class="completar-btn" data-item-id="{{ item.id }}" data-codigo="{{ item.codigo_articulo }}">Completar</button>
                    </td>
                    {% endif %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="text-align: center; margin-top: 2em;">
        <form action="{{ url_for('finalizar_packing', orden_id=orden.id) }}" method="POST">
            <button id="finalizar-btn-packing" type="submit" class="finalizar-btn">
                Marcar como Listo para Despacho
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- SECCIÓN DE ELEMENTOS GLOBALES DEL DOM ---
    const scanForm = document.getElementById('scan-form-packing');
    const scanInput = document.getElementById('scan-input-packing');
    const feedbackDiv = document.getElementById('scan-feedback-packing');
    const finalizarBtn = document.getElementById('finalizar-btn-packing');
    const toggleOcultar = document.getElementById('toggle-ocultar-completados');

    // --- SECCIÓN DE AUDIO ---
    const audioSuccess = new Audio("{{ url_for('static', filename='sounds/success.mp3') }}");
    const audioError = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");
    let audioUnlocked = false; 

    function unlockAudio() {
        if(audioUnlocked) return;
        new Audio("{{ url_for('static', filename='sounds/silent.mp3') }}").play().then(() => {
            audioUnlocked = true;
        }).catch(()=>{});
    }
    document.body.addEventListener('click', unlockAudio, { once: true });
    document.body.addEventListener('keydown', unlockAudio, { once: true });

    // --- LÓGICA DE ESCANEO PRINCIPAL ---
    scanForm.addEventListener('submit', function(event) {
        event.preventDefault(); 
        const codigo = scanInput.value.trim();
        if (!codigo) return;

        fetch("{{ url_for('api_escanear_item_packing', orden_id=orden.id) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo_articulo: codigo }),
        })
        .then(res => {
            if (!res.ok) {
                // Si la respuesta es un error (ej. 404, 422), lo manejamos aquí
                return res.json().then(errData => Promise.reject(errData));
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                if(audioUnlocked) audioSuccess.play();
                updatePackingUI(data);
                showPackingFeedback(data.message, 'success');
            }
        })
        .catch(error => {
            if(audioUnlocked) audioError.play();
            // El mensaje de error vendrá del JSON que rechazamos
            showPackingFeedback(error.message || 'Ocurrió un error desconocido.', 'error');
            console.error('Error en escaneo de packing:', error);
        })
        .finally(() => {
            scanInput.value = '';
            scanInput.focus();
        });
    });

    // --- LÓGICA PARA BOTÓN "COMPLETAR" DEL ADMIN ---
    document.querySelectorAll('.completar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const codigo = this.dataset.codigo;
            if (!confirm(`¿Marcar el ítem ${codigo} como 100% verificado para packing?`)) return;
            
            fetch(`/api/packing/item/${itemId}/completar`, { 
                method: 'POST',
                headers: { 'X-CSRF-Token': '{{ csrf_token() if csrf_token else "" }}' } // Para compatibilidad si añades CSRF
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if(audioUnlocked) audioSuccess.play();
                    updatePackingUI(data);
                    showPackingFeedback(data.message, 'success');
                } else {
                    if(audioUnlocked) audioError.play();
                    showPackingFeedback(data.message || 'Error al completar', 'error');
                }
            }).catch(err => {
                console.error('Error al completar ítem:', err);
                showPackingFeedback('Error de conexión.', 'error');
            });
        });
    });

    // --- LÓGICA PARA CHECKBOX "OCULTAR COMPLETADOS" ---
    toggleOcultar.addEventListener('change', function() {
        document.body.classList.toggle('ocultar-completados', this.checked);
    });

    // --- FUNCIONES AUXILIARES DE UI ---
    function updatePackingUI(data) {
        const row = document.getElementById(`item-row-${data.codigo_articulo}`);
        if (!row) return;

        const texto = row.querySelector(`#progreso-texto-${data.codigo_articulo}`);
        const barra = row.querySelector(`#progreso-barra-${data.codigo_articulo}`);
        
        if (texto) texto.textContent = `${data.escaneado} / ${data.solicitado}`;
        
        if (barra) {
            const porcentaje = data.solicitado > 0 ? (data.escaneado / data.solicitado) * 100 : 100;
            barra.style.width = `${porcentaje}%`;
            barra.textContent = `${Math.round(porcentaje)}%`;
        }

        row.classList.toggle('item-completado', data.escaneado >= data.solicitado);
        checkIfPackingIsComplete();
    }

    function showPackingFeedback(message, type) {
        feedbackDiv.textContent = message;
        feedbackDiv.className = `scan-feedback ${type}`;
        feedbackDiv.style.display = 'block';
        setTimeout(() => { feedbackDiv.style.display = 'none'; }, 3000);
    }

    function checkIfPackingIsComplete() {
        let completo = true;
        document.querySelectorAll('.item-row').forEach(row => {
            if (!row.classList.contains('item-completado')) {
                completo = false;
            }
        });
        finalizarBtn.disabled = !completo;
    }

    // --- INICIALIZACIÓN DE LA VISTA ---
    function inicializarVista() {
        document.querySelectorAll('.item-row').forEach(row => {
            const texto = row.querySelector('[id^="progreso-texto-"]').textContent;
            const [escaneados, solicitados] = texto.split('/').map(n => parseInt(n.trim(), 10));
            if (escaneados >= solicitados) {
                row.classList.add('item-completado');
            }
        });
        checkIfPackingIsComplete(); // Comprobar estado al cargar la página
        if (toggleOcultar.checked) {
            document.body.classList.add('ocultar-completados');
        }
    }
    
    inicializarVista();
});
</script>
{% endblock %}