{% extends "layout.html" %}

{% block title %}Packing Pedido #{{ orden.numero_pedido }}{% endblock %}

{% block styles %}
<style>
    /* --- Estilos Base (sin cambios) --- */
    .container { max-width: 900px; margin: 2em auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 0.5em; }
    .back-link { display: inline-block; margin-bottom: 1rem; color: #337ab7; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .scan-form { margin: 2em 0; display: flex; gap: 10px; flex-direction: column; }
    .scan-input { flex-grow: 1; font-size: 1.2rem; padding: 15px; border-radius: 5px; border: 2px solid #ccc; }
    .scan-btn { background-color: #337ab7; color: white; border: none; cursor: pointer; padding: 15px; border-radius: 5px; }
    .scan-feedback { padding: 1em; margin-top: 1em; border-radius: 5px; font-weight: bold; display: none; text-align: center; }
    .scan-feedback.success { background-color: #d4edda; color: #155724; }
    .scan-feedback.error { background-color: #f8d7da; color: #721c24; }
    .view-options { margin: 1rem 0; padding: 0.5rem; background-color: #f9f9f9; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ddd; padding: 0.8em; text-align: left; vertical-align: middle; }
    th { background-color: #f8f9fa; }
    .completar-btn { background-color: #337ab7; color: white; border: none; padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    .item-completado { background-color: #dff0d8 !important; color: #3c763d; }
    body.ocultar-completados .item-completado { display: none; }
    .progress-bar { background-color: #e9ecef; border-radius: 5px; overflow: hidden; height: 22px; border: 1px solid #ddd; }
    .progress { background-color: #337ab7; color: white; text-align: center; font-weight: bold; height: 100%; line-height: 22px; transition: width 0.4s ease-in-out; }
    #packing-finalization-section { margin-top: 2.5em; padding: 2em; border: 2px solid #28a745; background-color: #f8fdf8; border-radius: 8px; display: none; }
    .bultos-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; align-items: end; }
    .bultos-form-grid .form-group input { width: 100%; padding: 10px; font-size: 1.2rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; }
    .finalizar-btn { background-color: #28a745; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 1rem; }
    @media (min-width: 768px) {
        .scan-form { flex-direction: row; }
    }
    .lotes-section { margin-top: 1.5rem; }
    .lote-input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 0.5rem; }
    .lote-input-row input { flex-grow: 1; }
    .add-lote-btn { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    .remove-lote-btn { background-color: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('dashboard_packing') }}" class="back-link">← Volver a Packing</a>
    <!-- Botón para resetear el conteo -->
    <a href="{{ url_for('detalle_packing', orden_id=orden.id, reset='true') }}" class="action-link" style="float: right; background-color: #f0ad4e; color: white; padding: 8px 12px; text-decoration: none; border-radius: 4px;" onclick="return confirm('¿Está seguro de que desea reiniciar el conteo de packing para esta orden?');">Reiniciar Conteo</a>

    <h1>Verificación de Packing para Pedido #{{ orden.numero_pedido }}</h1>
    
    <!-- === INICIO: BLOQUE RESTAURADO === -->
    <form id="scan-form-packing" class="scan-form">
        <input type="text" id="scan-input-packing" class="scan-input" placeholder="Escanear artículo para verificar..." autofocus>
        <button type="submit" class="scan-btn">Escanear</button>
    </form>
    <div id="scan-feedback-packing" class="scan-feedback"></div>
    <!-- === FIN: BLOQUE RESTAURADO === -->

    <div class="view-options">
        <label>
            <input type="checkbox" id="toggle-ocultar-completados">
            Ocultar ítems completados
        </label>
    </div>

    <h2>Artículos de la Orden</h2>
    <table>
        <thead>
            <tr>
                <th>Código</th>
                <th>Descripción</th>
                <th>Progreso</th>
                {% if current_user.role == 'admin' %}<th>Acción</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in orden.items %}
                <tr class="item-row" id="item-row-{{ item.codigo_articulo }}">
                    <td><strong>{{ item.codigo_articulo }}</strong></td>
                    <td>{{ item.descripcion_articulo }}</td>
                    <td>
                        {% set escaneados = item.cantidad_empacada %}
                        {% set solicitados = item.cantidad_solicitada %}
                        <span id="progreso-texto-{{ item.codigo_articulo }}">{{ escaneados }} / {{ solicitados }}</span>
                        <div class="progress-bar">
                            {% set progreso_inicial = (escaneados / solicitados) * 100 if solicitados > 0 else (100 if escaneados >= solicitados else 0) %}
                            <div id="progreso-barra-{{ item.codigo_articulo }}" class="progress" style="width: {{ progreso_inicial }}%;">
                                {{ '%.0f'|format(progreso_inicial) }}%
                            </div>
                        </div>
                    </td>
                    {% if current_user.role == 'admin' %}
                    <td style="text-align: center;" class="action-buttons">
                        <button class="completar-btn" data-item-id="{{ item.id }}" data-codigo="{{ item.codigo_articulo }}">Completar</button>
                    </td>
                    {% endif %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div id="packing-finalization-section">
        <h2 style="text-align:center; color:#28a745;">¡Verificación Completa!</h2>
        <p style="text-align:center;">Registra cómo se empacaron los productos para generar las etiquetas.</p>
        <form action="{{ url_for('finalizar_packing', orden_id=orden.id) }}" method="POST">
             <div class="bultos-form-grid">
                <div class="form-group">
                    <label for="cantidad_cajas">Nº de Cajas</label>
                    <input type="number" name="cantidad_cajas" value="0" min="0">
                </div>
                 <div class="form-group">
                    <label for="cantidad_bolsas">Nº de Bolsas</label>
                    <input type="number" name="cantidad_bolsas" value="0" min="0">
                </div>
                 <div class="form-group">
                    <label for="cantidad_paquetes">Nº de Paquetes</label>
                    <input type="number" name="cantidad_paquetes" value="0" min="0">
                </div>
            </div>

            <hr>
            <!-- --- Nueva sección para Lotes --- -->
            <div class="lotes-section">
                <h4>Empaques por Lote</h4>
                <div id="lotes-container">
                    <!-- Los inputs de lote se añadirán aquí dinámicamente -->
                </div>
                <button type="button" id="add-lote-btn" class="add-lote-btn">Añadir Lote</button>
            </div>
            
            <button type="submit" class="finalizar-btn">Generar Etiquetas y Finalizar</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- El bloque de JavaScript no necesita ningún cambio funcional. -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanForm = document.getElementById('scan-form-packing');
    const scanInput = document.getElementById('scan-input-packing');
    const feedbackDiv = document.getElementById('scan-feedback-packing');
    const toggleOcultar = document.getElementById('toggle-ocultar-completados');
    const finalizationSection = document.getElementById('packing-finalization-section');
    const audioSuccess = new Audio("{{ url_for('static', filename='sounds/success.mp3') }}");
    const audioError = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");

    // --- Lógica de desbloqueo de audio (opcional, pero buena práctica) ---
    let audioUnlocked = false;
    function unlockAudio() {
        if (audioUnlocked) return;
        new Audio("{{ url_for('static', filename='sounds/silent.mp3') }}").play().then(() => {
            audioUnlocked = true;
        }).catch(() => {});
    }
    document.body.addEventListener('click', unlockAudio, { once: true });
    document.body.addEventListener('keydown', unlockAudio, { once: true });


    scanForm.addEventListener('submit', function(event) {
        event.preventDefault(); 
        const codigo = scanInput.value.trim();
        if (!codigo) return;

        fetch("{{ url_for('api_escanear_item_packing', orden_id=orden.id) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo_articulo: codigo }),
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if(audioUnlocked) audioSuccess.play();
                updatePackingUI(data);
                showPackingFeedback(data.message, 'success');
            } else {
                if(audioUnlocked) audioError.play();
                showPackingFeedback(data.message || 'Ocurrió un error', 'error');
            }
        })
        .catch(error => {
            console.error('Error en escaneo de packing:', error);
            showPackingFeedback('Error de conexión.', 'error');
        })
        .finally(() => {
            scanInput.value = '';
            scanInput.focus();
        });
    });

    document.querySelectorAll('.completar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const codigo = this.dataset.codigo;
            if (!confirm(`¿Marcar el ítem ${codigo} como 100% verificado para packing?`)) return;
            
            fetch(`/api/packing/item/${itemId}/completar`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if(audioUnlocked) audioSuccess.play();
                    updatePackingUI(data);
                    showPackingFeedback(data.message, 'success');
                } else {
                    if(audioUnlocked) audioError.play();
                    showPackingFeedback(data.message || 'Error al completar', 'error');
                }
            }).catch(err => {
                console.error('Error al completar ítem:', err);
                showPackingFeedback('Error de conexión.', 'error');
            });
        });
    });

    toggleOcultar.addEventListener('change', function() {
        document.body.classList.toggle('ocultar-completados', this.checked);
    });

    function updatePackingUI(data) {
        const row = document.getElementById(`item-row-${data.codigo_articulo}`);
        if (!row) return;

        const texto = row.querySelector(`#progreso-texto-${data.codigo_articulo}`);
        const barra = row.querySelector(`#progreso-barra-${data.codigo_articulo}`);
        
        if (texto) texto.textContent = `${data.escaneado} / ${data.solicitado}`;
        
        if (barra) {
            const porcentaje = data.solicitado > 0 ? (data.escaneado / data.solicitado) * 100 : 100;
            barra.style.width = `${porcentaje}%`;
            barra.textContent = `${Math.round(porcentaje)}%`;
        }

        row.classList.toggle('item-completado', data.escaneado >= data.solicitado);
        checkIfPackingIsComplete();
    }

    function showPackingFeedback(message, type) {
        feedbackDiv.textContent = message;
        feedbackDiv.className = `scan-feedback ${type}`;
        feedbackDiv.style.display = 'block';
        setTimeout(() => { feedbackDiv.style.display = 'none'; }, 3000);
    }

    function checkIfPackingIsComplete() {
        let completo = true;
        document.querySelectorAll('.item-row').forEach(row => {
            if (!row.classList.contains('item-completado')) {
                completo = false;
            }
        });
        
        if (completo) {
            finalizationSection.style.display = 'block';
        } else {
            finalizationSection.style.display = 'none';
        }
    }

    function inicializarVista() {
        document.querySelectorAll('.item-row').forEach(row => {
            const texto = row.querySelector('[id^="progreso-texto-"]').textContent;
            const [escaneados, solicitados] = texto.split('/').map(n => parseInt(n.trim(), 10));
            if (escaneados >= solicitados) {
                row.classList.add('item-completado');
            }
        });
        checkIfPackingIsComplete();
        if (toggleOcultar.checked) {
            document.body.classList.add('ocultar-completados');
        }
    }
    
    inicializarVista();
});
    const addLoteBtn = document.getElementById('add-lote-btn');
            const lotesContainer = document.getElementById('lotes-container');

            addLoteBtn.addEventListener('click', function() {
                const newRow = document.createElement('div');
                newRow.className = 'lote-input-row form-group';

                const input = document.createElement('input');
                input.type = 'number';
                input.name = 'lote_cantidades'; // Usamos el mismo nombre para que form.getlist funcione
                input.placeholder = 'Cantidad de unidades en este lote';
                input.min = '1';
                input.required = true;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-lote-btn';
                removeBtn.textContent = 'Quitar';
                removeBtn.onclick = function() {
                    lotesContainer.removeChild(newRow);
                };

                newRow.appendChild(input);
                newRow.appendChild(removeBtn);
                lotesContainer.appendChild(newRow);
            });
</script>
{% endblock %}