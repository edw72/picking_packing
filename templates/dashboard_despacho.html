{% extends "layout.html" %}

{% block title %}Dashboard de Despacho{% endblock %}

{% block styles %}
    <style>
        .estado { font-weight: bold; padding: 0.2em 0.5em; border-radius: 4px; color: white; display: inline-block; }
        .estado-LISTO_PARA_DESPACHO { background-color: #337ab7; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; background-color: white; }
        th, td { border: 1px solid #ddd; padding: 0.8em; text-align: left; }
        th { background-color: #f8f9fa; }
        .action-link { padding: 8px 15px; font-size: 14px; font-weight: bold; color: white; background-color: #f0ad4e; border-radius: 5px; text-decoration: none; text-align: center; margin: 5px; }
        .correct-btn { 
            background-color: #f0ad4e; 
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        .navegacion-modulos { margin-bottom: 1.5em; padding: 1em; background-color: #e9ecef; border-radius: 5px; }
    </style>
{% endblock %}

{% block content %}
    <h1>Órdenes en Espera de Ruta</h1>
    <p>Estas órdenes están empacadas y listas. Asigne un destino para que puedan ser añadidas a una Hoja de Ruta.</p>

    <div class="navegacion-modulos" style="margin-bottom: 2rem;">
        <strong>Módulos:</strong>
        <a href="{{ url_for('dashboard') }}">Picking</a> |
        <a href="{{ url_for('dashboard_packing') }}">Packing</a> |
        <a href="{{ url_for('dashboard_despacho') }}" style="font-weight: bold; color: #337ab7;">Despacho</a>
        {% if current_user.role == 'admin' %}
        | <a href="{{ url_for('reportes_y_busqueda') }}">Reportes</a>
        {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <table>
        <thead>
            <tr>
                <th>Pedido #</th>
                <th>Cliente</th>
                <th>Destino Asignado</th> <!-- Nueva Columna -->
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes_para_despacho %}
            <tr>
                <td>{{ orden.numero_pedido }}</td>
                <td>{{ orden.cliente_nombre }}</td>
                <td>
                    <!-- Mostramos el destino si existe -->
                    {% if orden.destino %}
                        <strong>{{ orden.destino.nombre }}</strong>
                    {% else %}
                        <span style="color: #d9534f;">Pendiente</span>
                    {% endif %}
                </td>
                <td>
                    <!-- El enlace ahora apunta a la nueva página -->
                    <a href="{{ url_for('asignar_destino', orden_id=orden.id) }}" class="action-link">
                        {% if orden.destino %}Editar Destino{% else %}Asignar Destino{% endif %}
                    </a>
                    <!-- === INICIO: NUEVO BOTÓN PARA CORREGIR EMPAQUE === -->
                    <form action="{{ url_for('corregir_empaque_orden', orden_id=orden.id) }}" method="POST" style="display: inline;" 
                          onsubmit="return confirm('¿Está seguro de que desea corregir el empaque? Se borrarán las etiquetas existentes y deberá finalizar el packing de nuevo.');">
                        <button type="submit" class="action-link correct-btn">Corregir Empaque</button>
                    </form>
                    <!-- === FIN: NUEVO BOTÓN === -->
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="text-align: center; padding: 2em;">¡Excelente! No hay órdenes listas para despacho en este momento.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}