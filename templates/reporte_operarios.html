{% extends "layout.html" %}

{% block title %}Reporte de Rendimiento por Operario{% endblock %}

{% block styles %}
<style>
    /* Estilos para el contenedor principal y filtros */
    h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .periodo-filtros { margin-bottom: 1.5rem; padding: 1rem; background-color: #f0f0f0; border-radius: 5px; }
    .periodo-filtros a { text-decoration: none; padding: 8px 15px; margin-right: 10px; border-radius: 5px; color: #007bff; border: 1px solid #007bff; }
    .periodo-filtros a.activo { background-color: #007bff; color: white; font-weight: bold; }

    /* Estilos para los gráficos */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
        min-width: 0; 
    }
    @media (min-width: 1200px) {
        .charts-grid { grid-template-columns: 1fr 1fr; }
    }
    .chart-container {
        position: relative;
        width: 100%;
        background-color: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    /* Estilos para la tabla detallada */
    .kpi-table {
        width: 100%;
        margin-top: 1rem;
        background-color: white;
        border-collapse: collapse;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .kpi-table th, .kpi-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .kpi-table th { background-color: #f8f9fa; font-weight: bold; }
    .kpi-table td.numeric { text-align: right; font-family: monospace, monospace; font-size: 1.1em; }
</style>
{% endblock %}

{% block content %}
    <h1>Reporte de Rendimiento por Operario</h1>
    <p>Mostrando datos desde el {{ fecha_inicio.strftime('%d-%m-%Y') }}.</p>

    <!-- Filtros de Periodo -->
    <div class="periodo-filtros">
        <strong>Seleccionar Periodo:</strong>
        <a href="{{ url_for('reporte_operarios', periodo='hoy') }}" class="{{ 'activo' if periodo_actual == 'hoy' }}">Hoy</a>
        <a href="{{ url_for('reporte_operarios', periodo='semana') }}" class="{{ 'activo' if periodo_actual == 'semana' }}">Últimos 7 días</a>
        <a href="{{ url_for('reporte_operarios', periodo='mes') }}" class="{{ 'activo' if periodo_actual == 'mes' }}">Este Mes</a>
    </div>

    <!-- Contenedores para los Gráficos -->
    <div class="charts-grid">
        <div class="chart-container" style="height: 400px;">
            <canvas id="cantidadesChart"></canvas>
        </div>
        <div class="chart-container" style="height: 400px;">
            <canvas id="tiemposChart"></canvas>
        </div>
    </div>

    <!-- La tabla de datos detallados -->
    <h2>Datos Detallados (Reporte tipo Ficha)</h2>
    <table class="kpi-table">
        <thead>
            <tr>
                <th rowspan="2">Operario</th>
                <th colspan="3" style="text-align: center; background-color: #d9edf7;">Picking</th>
                <th colspan="2" style="text-align: center; background-color: #dff0d8;">Packing</th>
            </tr>
            <tr>
                <!-- Sub-encabezados -->
                <th style="text-align: right;">Lotes Completados</th>
                <th style="text-align: right;">Unidades Recogidas</th>
                <th style="text-align: right;">Tiempo Prom. Lote</th>
                <th style="text-align: right;">Órdenes Empacadas</th>
                <th style="text-align: right;">Tiempo Prom. Orden</th>
            </tr>
        </thead>
        <tbody>
            <!-- Bucle principal para las filas de la tabla -->
            {% for user, lotes, tiempo_pick, items, ordenes_pack, tiempo_pack in reporte_data %}
            <tr>
                <td><strong>{{ user.username }}</strong></td>
                <td class="numeric">{{ lotes or 0 }}</td>
                <td class="numeric">{{ items or 0 }}</td>
                <td class="numeric">
                    <!-- Bloque IF/ELSE para tiempo_pick -->
                    {% if tiempo_pick %}
                        {% set minutes = (tiempo_pick / 60) | int %}
                        {% set seconds = tiempo_pick % 60 %}
                        {{ '%02d:%02d' | format(minutes, seconds) }} min
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td class="numeric">{{ ordenes_pack or 0 }}</td>
                <td class="numeric">
                    <!-- Bloque IF/ELSE para tiempo_pack -->
                    {% if tiempo_pack %}
                        {% set minutes = (tiempo_pack / 60) | int %}
                        {% set seconds = tiempo_pack % 60 %}
                        {{ '%02d:%02d' | format(minutes, seconds) }} min
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6" style="text-align: center; padding: 2rem;">No hay datos de operarios para mostrar.</td></tr>
            <!-- Etiqueta de cierre para el bucle for -->
            {% endfor %}
        </tbody>
    </table>
{% endblock %}


{% block scripts %}
<!-- Añadimos la librería Chart.js desde un CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const periodo = urlParams.get('periodo') || 'semana';
    const periodoTitle = periodo.charAt(0).toUpperCase() + periodo.slice(1);

    fetch(`/api/reportes/rendimiento-operarios?periodo=${periodo}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) return;

            const labels = data.map(op => op.username);
            
            // Datos para Gráfico 1: Cantidades
            const lotesData = data.map(op => op.lotes_completados);
            const itemsData = data.map(op => op.items_recogidos);
            const ordenesPackData = data.map(op => op.ordenes_empacadas);

            // Datos para Gráfico 2: Tiempos (en minutos)
            const tiempoPickingData = data.map(op => (op.tiempo_prom_picking / 60).toFixed(2));
            const tiempoPackingData = data.map(op => (op.tiempo_prom_packing / 60).toFixed(2));

            // Renderizar Gráfico 1: Cantidades
            const ctxCantidades = document.getElementById('cantidadesChart').getContext('2d');
            new Chart(ctxCantidades, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Lotes Completados', data: lotesData, backgroundColor: 'rgba(54, 162, 235, 0.7)' },
                        { label: 'Órdenes Empacadas', data: ordenesPackData, backgroundColor: 'rgba(75, 192, 192, 0.7)' },
                        { label: 'Unidades Recogidas', data: itemsData, backgroundColor: 'rgba(255, 159, 64, 0.7)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: `Rendimiento de Cantidades (${periodoTitle})`, font: { size: 16 } } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            // Renderizar Gráfico 2: Tiempos
            const ctxTiempos = document.getElementById('tiemposChart').getContext('2d');
            new Chart(ctxTiempos, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Tiempo Prom. Picking (min)', data: tiempoPickingData, backgroundColor: 'rgba(153, 102, 255, 0.7)' },
                        { label: 'Tiempo Prom. Packing (min)', data: tiempoPackingData, backgroundColor: 'rgba(255, 99, 132, 0.7)' }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: `Tiempos Promedio por Tarea (${periodoTitle})`, font: { size: 16 } },
                        tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw} minutos`; } } }
                    },
                    scales: { x: { beginAtZero: true, title: { display: true, text: 'Minutos' } } }
                }
            });
        })
        .catch(error => console.error('Error al cargar datos para los gráficos:', error));
});
</script>
{% endblock %}